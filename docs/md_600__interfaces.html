<!-- HTML header for doxygen 1.8.3-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3"/>
<title>DoReMIR Audio Engine: Interfaces</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="styles.css" rel="stylesheet" type="text/css" />
<!-- <link href="doxygen.css" rel="stylesheet" type="text/css" /> -->
<!--  -->
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DoReMIR Audio Engine
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_600__interfaces.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Interfaces </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#Using">Using an interface</a><ul><li class="level2"><a href="#GenericFunctions">Generic functions</a></li>
<li class="level2"><a href="#GenericPointers">Generic values</a></li>
<li class="level2"><a href="#DynInterfaceCheck">Dynamic checks</a></li>
</ul>
</li>
<li class="level1"><a href="#Defining">Defining an interface</a><ul><li class="level2"><a href="#DefStruct">The interface structure</a></li>
<li class="level2"><a href="#DefId">The interface identifier</a></li>
<li class="level2"><a href="#DefGen">Global generic functions</a></li>
</ul>
</li>
<li class="level1"><a href="#Implementing">Implementing an interface</a><ul><li class="level2"><a href="#Methods">The methods</a></li>
<li class="level2"><a href="#Dispatch">The dispatch function</a></li>
<li class="level2"><a href="#Pointer">The interface pointer</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="Interfaces"></a></p>
<p>An <em>interface</em> is a collection of function types, identified by a unique value known as the <em>interface identifier</em>. They are used extensively inside the Audio Engine.</p>
<p>Any <a href="http://en.wikipedia.org/wiki/Reference_type">reference type</a> may provide implementations for an arbitrary number of interfaces by implementing a so-called <em>dispatch function</em>, which takes a reference of the given type and an interface identifier and returns a pointer to a structure conforming to the interface type. This structure is known as an <em>implementation</em>.</p>
<p>Interfaces can be used to decorate a type with additional semantics such as <a class="el" href="structdoremir__equal__t.html">equality</a> or <a class="el" href="structdoremir__order__t.html">ordering</a>. Another use is to overload common functionality, such as <a class="el" href="structdoremir__number__t.html">arithmetic operators</a>.</p>
<h1><a class="anchor" id="Using"></a>
Using an interface</h1>
<p>Interface methods are called by invoking <a class="el" href="group___doremir.html#ga13e504d69d14795f9dbe70fc0b298176">interface</a>, passing the interface identifier and the value on which the interface is going to be dispatched. This is usually one of the arguments to the invoked method, but it can be any value. If the given value does not implement the interface, <a class="el" href="group___doremir.html#ga13e504d69d14795f9dbe70fc0b298176">interface</a> returns null.</p>
<p>Note that <a class="el" href="group___doremir.html#ga13e504d69d14795f9dbe70fc0b298176">interface</a> is actually the <em>only</em> way to call an interface method: in particular it is not safe to cast a pointer of some type to the interface type and call the methods from that pointer. It follows that you must not use a pointer to an interface type (such as <a class="el" href="structdoremir__equal__t.html">Equal</a>) as an argument to <a class="el" href="group___doremir.html#ga13e504d69d14795f9dbe70fc0b298176">interface</a>.</p>
<h2><a class="anchor" id="GenericFunctions"></a>
Generic functions</h2>
<p>Interfaces are commonly used to implement generic functions, which are functions using an interface method without knowledge of the exact type. Generic functions generally accept one or more parameters of type <code>void *</code>.</p>
<p>For example, this is a way to implement the <em>min</em> function for any type supporing the <a class="el" href="structdoremir__order__t.html">Order</a> interface.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> * <a class="code" href="group___doremir.html#ga1d06597eb4a61c15d56a7d230d1c47a0">doremir_min</a>(<span class="keywordtype">void</span> *a, <span class="keywordtype">void</span> *b) </div>
<div class="line">{             </div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="group___doremir.html#ga13e504d69d14795f9dbe70fc0b298176">doremir_interface</a>(doremir_order_i, a)-&gt;less_than(a, b) ? a : b;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Note that most interfaces define generic functions wrapping their methods, saving the user from having to write an explicit <a class="el" href="group___doremir.html#ga13e504d69d14795f9dbe70fc0b298176">interface</a> call. By convention, the wrapper should be a function of the same name as the interface method. Thus the above function could be defined more briefly as follows.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> * <a class="code" href="group___doremir.html#ga1d06597eb4a61c15d56a7d230d1c47a0">doremir_min</a>(<span class="keywordtype">void</span> *a, <span class="keywordtype">void</span> *b)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="group___doremir.html#ga7efe568c791238a4fc93316a00a6f19c">doremir_less_than</a>(a, b) ? a : b;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Note that the restriction on arguments to generic functions correspond to <em>universal</em> quantification (i.e. it says <em>for any type</em> a <em>such that</em> a <em>implements the equal interface</em>).</p>
<h2><a class="anchor" id="GenericPointers"></a>
Generic values</h2>
<p>TODO</p>
<p>Note that restriction on generic values correspond to <em>existential</em> quantification (i.e. it says <em>for some type</em> a <em>such that</em> a <em>implements the equal interface</em>).</p>
<h2><a class="anchor" id="DynInterfaceCheck"></a>
Dynamic checks</h2>
<p>As <a class="el" href="group___doremir.html#ga13e504d69d14795f9dbe70fc0b298176">interface</a> returns a pointer to the interface or <code>null</code>, it can be used for dynamically inspecting a whether an arbitrary value supports an interface or not. If a type is known to support an interface at compile-time, this check can be omitted.</p>
<p>This is a way to implement a safe equality check, which compares using the equal interface if the given value implements it, and compares their addresses otherwise.</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> safe_equal(<span class="keywordtype">void</span> *a, <span class="keywordtype">void</span> *b)</div>
<div class="line">{       </div>
<div class="line">    <a class="code" href="structdoremir__equal__t.html" title="Equality comparison interface.">doremir_equal_t</a> *equal = <a class="code" href="group___doremir.html#ga13e504d69d14795f9dbe70fc0b298176">doremir_interface</a>(doremir_equal_i, a);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (equal)</div>
<div class="line">        <span class="keywordflow">return</span> equal-&gt;<a class="code" href="structdoremir__equal__t.html#a88a152d9cda96611f5dc5f7b36954b42">equal</a>(a, b);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        <span class="keywordflow">return</span> a == b;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="Defining"></a>
Defining an interface</h1>
<p>To define a new interface, the following has to be provided:</p>
<ul>
<li>An interface struct</li>
<li>An interface identifier</li>
</ul>
<h2><a class="anchor" id="DefStruct"></a>
The interface structure</h2>
<p>The struct is simply a typedef defining the types of the interface, for example</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line"></div>
<div class="line">    bool (* less_than)(<span class="keywordtype">void</span> *, <span class="keywordtype">void</span> *);</div>
<div class="line"></div>
<div class="line">    bool (* greater_than)(<span class="keywordtype">void</span> *, <span class="keywordtype">void</span> *);</div>
<div class="line"></div>
<div class="line">} <a class="code" href="structdoremir__order__t.html" title="Less-than comparison interface.">doremir_order_t</a>;</div>
</div><!-- fragment --><h2><a class="anchor" id="DefId"></a>
The interface identifier</h2>
<p>The identifier should be defined as a macro or enum constant defining a unique number.</p>
<div class="fragment"><div class="line"><span class="keyword">enum</span> { doremir_order_i = 255; };</div>
</div><!-- fragment --><h2><a class="anchor" id="DefGen"></a>
Global generic functions</h2>
<p>As described above, it is good style to also provide a generic function wrapping each method:</p>
<div class="fragment"><div class="line"><span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="group___doremir.html#ga7efe568c791238a4fc93316a00a6f19c">doremir_less_than</a> (<span class="keywordtype">void</span> *, <span class="keywordtype">void</span> *)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="group___doremir.html#ga13e504d69d14795f9dbe70fc0b298176">doremir_interface</a>(doremir_order_i, a)-&gt;less_than(a, b);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="group___doremir.html#gaa1eda3d895f5d6e3949990a6cb17647d">doremir_greater_than</a> (<span class="keywordtype">void</span> *, <span class="keywordtype">void</span> *)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="group___doremir.html#ga13e504d69d14795f9dbe70fc0b298176">doremir_interface</a>(doremir_order_i, a)-&gt;greater_than(a, b);</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="Implementing"></a>
Implementing an interface</h1>
<p>To implement an interface for a reference type, the following has to be provided:</p>
<ul>
<li>Functions implementing the interface methods</li>
<li>A dispatch function of type <a class="el" href="group___doremir.html#gae005a60eed3e88f89255fc532efb1980">Impl</a></li>
<li>A field in the type that points to the dispatch function</li>
<li>A construction routine that sets the pointer to the dispatch function</li>
</ul>
<p>The dispatch function is unique for each type, and performs a case matching on the incoming interface identifiers, returning a pointer to the appropriate interface struct.</p>
<p>As an example, let us write a custom reference type <code>foo</code>, implementing <a class="el" href="structdoremir__equal__t.html">doremir_equal_t</a> and <a class="el" href="structdoremir__order__t.html">Order</a>.</p>
<h2><a class="anchor" id="Methods"></a>
The methods</h2>
<p>The methods are written as ordinary functions, which have the same type as the functions declared in the interface struct. These functions does need not be exported.</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> foo_equal(<span class="keywordtype">void</span> *a, <span class="keywordtype">void</span> *b)</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> foo_less_than(<span class="keywordtype">void</span> *a, <span class="keywordtype">void</span> *b)</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> foo_greater_than(<span class="keywordtype">void</span> *a, <span class="keywordtype">void</span> *b)</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="Dispatch"></a>
The dispatch function</h2>
<p>The dispatch function should have the type <a class="el" href="group___doremir.html#gae005a60eed3e88f89255fc532efb1980">Impl</a>. For example:</p>
<div class="fragment"><div class="line"><a class="code" href="group___doremir.html#gad5d15412474b902d32e40ee60eccba21" title="Generic pointer type.">doremir_ptr_t</a> foo_impl(<a class="code" href="group___doremir.html#ga48bf242c41cfd684ce1390ec12f8b1e0" title="Unique identifier.">doremir_id_t</a> interface)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">static</span> <a class="code" href="structdoremir__equal__t.html" title="Equality comparison interface.">doremir_equal_t</a> foo_equal_impl = { foo_equal };</div>
<div class="line">    <span class="keyword">static</span> <a class="code" href="structdoremir__order__t.html" title="Less-than comparison interface.">doremir_order_t</a> foo_order_impl = { foo_less_than, foo_greater_than };</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">switch</span> (interface)</div>
<div class="line">    {</div>
<div class="line">    <span class="keywordflow">case</span> doremir_equal_i:</div>
<div class="line">        <span class="keywordflow">return</span> &amp;foo_equal_impl;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">case</span> doremir_order_i:</div>
<div class="line">        <span class="keywordflow">return</span> &amp;foo_order_impl;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="Pointer"></a>
The interface pointer</h2>
<p>The address of the dispatch function has to be the <em>first</em> element of the implementing type. The name of the fields is irrelevant, typically <code>impl</code> is used.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>foo</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group___doremir.html#gae005a60eed3e88f89255fc532efb1980" title="Callback to lookup an interface implementation.">doremir_impl_t</a> impl; <span class="comment">/* Interface dispatcher* /</span></div>
<div class="line"><span class="comment">    ...</span></div>
<div class="line"><span class="comment">};</span></div>
</div><!-- fragment --><p>The creation routine for the type should include a line to set up the <code>impl</code> field to the address of the dispatch function. Note that a forward delcaration might be necessary here.</p>
<div class="fragment"><div class="line"><a class="code" href="group___doremir.html#gad5d15412474b902d32e40ee60eccba21" title="Generic pointer type.">doremir_ptr_t</a> foo_impl(<a class="code" href="group___doremir.html#ga48bf242c41cfd684ce1390ec12f8b1e0" title="Unique identifier.">doremir_id_t</a> interface);</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>foo *create_foo()</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>foo *foo = malloc(<span class="keyword">sizeof</span>(_foo));</div>
<div class="line">    foo-&gt;impl = &amp;foo_impl;                      <span class="comment">/* Setting up dispatcher */</span></div>
<div class="line">    ...</div>
<div class="line">    <span class="keywordflow">return</span> foo;</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.3-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sat Jan 26 2013 03:39:03 for DoReMIR Audio Engine by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.3 </li>
  </ul>
</div>
</body>
</html>
