<!-- HTML header for doxygen 1.8.3-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3"/>
<title>faudio v2.2.3: Interfaces</title>
<!-- <link href="tabs.css" rel="stylesheet" type="text/css"/> -->
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="styles.css" rel="stylesheet" type="text/css" />
<!-- <link href="doxygen.css" rel="stylesheet" type="text/css" /> -->
<!--  -->
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">faudio v2.2.3
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Introduction</span></a></li>
      <li class="current"><a href="pages.html"><span>Documentation</span></a></li>
      <li><a href="modules.html"><span>API&#160;Reference</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Interfaces </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#Using">Using an interface</a><ul><li class="level2"><a href="#GenericFunctions">Generic functions</a></li>
<li class="level2"><a href="#GenericPointers">Generic values</a></li>
<li class="level2"><a href="#DynInterfaceCheck">Dynamic checks</a></li>
</ul>
</li>
<li class="level1"><a href="#Defining">Defining an interface</a></li>
<li class="level1"><a href="#Implementing">Implementing an interface</a><ul><li class="level2"><a href="#Methods">The methods</a></li>
<li class="level2"><a href="#Dispatch">The dispatch function</a></li>
<li class="level2"><a href="#Pointer">The interface pointer</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="Interfaces"></a></p>
<p>In faudio, an <em>interface</em> (not to be confuseed with and <em>audio interface</em>) is a collection of function types, identified by a unique value known as the <em>interface identifier</em>. They are used extensively inside faudio.</p>
<p>In <em>faudio</em>, all non-primitive types are defined as <a href="http://en.wikipedia.org/wiki/Reference_type">reference types</a>, and may provide implementations for an arbitrary number of interfaces by implementing a so-called <em>dispatch function</em>, which takes a reference of the given type and an interface identifier and returns a pointer to a structure conforming to the interface type. This structure is known as an <em>implementation</em>.</p>
<p>Interfaces can be used to decorate a type with additional semantics such as <a class="el" href="structfa__equal__t.html">equality</a> or <a class="el" href="structfa__order__t.html">ordering</a>. Another use is to overload common functionality, such as <a class="el" href="structfa__number__t.html">arithmetic operators</a>.</p>
<div class="fragment"><div class="line"><a class="code" href="group___fa_list.html#ga35ecb12ab934ded0cce0bcf28e3bc5d2">fa_list_t</a> numbers1 = fa_list_of(<a class="code" href="util_8h.html#a832509ea197065489f1d60b6d7958cbf">i32</a>, 1, 2, 3, 4, 5);</div>
<div class="line"><a class="code" href="group___fa_list.html#ga35ecb12ab934ded0cce0bcf28e3bc5d2">fa_list_t</a> numbers2 = fa_list_of(<a class="code" href="util_8h.html#a832509ea197065489f1d60b6d7958cbf">i32</a>, 6, 7, 8);</div>
<div class="line"></div>
<div class="line"><a class="code" href="group___fa.html#ga9215cf018539286a2ccd5c5f69ddb7f6" title="Print the given value, using Show.">fa_print</a>(<span class="stringliteral">&quot;%b&quot;</span>, <a class="code" href="group___fa.html#ga02de7d3cb44fba7a2b9cafa567e41307">fa_less_than</a>(numbers1, numbers2));</div>
</div><!-- fragment --><h1><a class="anchor" id="Using"></a>
Using an interface</h1>
<p>Interface methods are called by invoking <a class="el" href="group___fa.html#ga95dbbc4b32707af0a81071e8870d86c5">fa_interface</a>, passing the interface identifier and the value on which the interface is going to be dispatched. This is usually one of the arguments to the invoked method, but it can be any value. If the given value does not implement the interface, <a class="el" href="group___fa.html#ga95dbbc4b32707af0a81071e8870d86c5">fa_interface</a> returns <code>NULL</code>.</p>
<p>Note that <a class="el" href="group___fa.html#ga95dbbc4b32707af0a81071e8870d86c5">fa_interface</a> is actually the <em>only</em> way to call an interface method: in particular it is not safe to cast a pointer of some type to the interface type and call the methods from that pointer. It follows that you must not use a pointer to an interface type (such as <a class="el" href="structfa__equal__t.html">fa_equal_t</a>) as an argument to <a class="el" href="group___fa.html#ga95dbbc4b32707af0a81071e8870d86c5">fa_interface</a>.</p>
<h2><a class="anchor" id="GenericFunctions"></a>
Generic functions</h2>
<p>Interfaces are commonly used to implement generic functions, which are functions using an interface method without knowledge of the exact type. Generic functions generally accept one or more parameters of type <code>void *</code>.</p>
<p>For example, this is a way to implement the <em>min</em> function for any type supporing the <a class="el" href="structfa__order__t.html" title="Less-than comparison interface.">fa_order_t</a> interface.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> * <a class="code" href="group___fa.html#gaa4c932e61c244bb35c6a8b930ebd3137">fa_min</a>(<span class="keywordtype">void</span> *a, <span class="keywordtype">void</span> *b) </div>
<div class="line">{             </div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="group___fa.html#ga95dbbc4b32707af0a81071e8870d86c5" title="Returns an implenentation of the given interface on the given value.">fa_interface</a>(<a class="code" href="interfaces_8h.html#a7c337b4de759549a84c656770ce01cd2ae08a92558a44d2796dc2a5df8ff1b3c3">fa_order_i</a>, a)-&gt;less_than(a, b) ? a : b;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Note that most interfaces define generic functions wrapping their methods, saving the user from having to write an explicit <a class="el" href="group___fa.html#ga95dbbc4b32707af0a81071e8870d86c5">fa_interface</a> call. By convention, the wrapper should be a function of the same name as the interface method. Thus the above function could be defined more briefly as follows.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> * <a class="code" href="group___fa.html#gaa4c932e61c244bb35c6a8b930ebd3137">fa_min</a>(<span class="keywordtype">void</span> *a, <span class="keywordtype">void</span> *b)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="group___fa.html#ga02de7d3cb44fba7a2b9cafa567e41307">fa_less_than</a>(a, b) ? a : b;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Note that the restriction on arguments to generic functions correspond to <em>universal</em> quantification (i.e. it says <em>for any type</em> a <em>such that</em> a <em>implements the equal interface</em>).</p>
<h2><a class="anchor" id="GenericPointers"></a>
Generic values</h2>
<p>TODO</p>
<p>Note that restriction on generic values correspond to <em>existential</em> quantification (i.e. it says <em>for some type</em> a <em>such that</em> a <em>implements the equal interface</em>).</p>
<h2><a class="anchor" id="DynInterfaceCheck"></a>
Dynamic checks</h2>
<p>As <a class="el" href="group___fa.html#ga95dbbc4b32707af0a81071e8870d86c5">fa_interface</a> returns a pointer to the interface or <code>null</code>, it can be used for dynamically inspecting a whether an arbitrary value supports an interface or not. If a type is known to support an interface at compile-time, this check can be omitted.</p>
<p>This is a way to implement a safe equality check, which compares using the equal interface if the given value implements it, and compares their addresses otherwise.</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> safe_equal(<span class="keywordtype">void</span> *a, <span class="keywordtype">void</span> *b)</div>
<div class="line">{       </div>
<div class="line">    <a class="code" href="structfa__equal__t.html" title="Equality comparison interface.">fa_equal_t</a> *equal = <a class="code" href="group___fa.html#ga95dbbc4b32707af0a81071e8870d86c5" title="Returns an implenentation of the given interface on the given value.">fa_interface</a>(<a class="code" href="interfaces_8h.html#a7c337b4de759549a84c656770ce01cd2a9b8bb278c9a713e6ec54d275002e0a01">fa_equal_i</a>, a);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (equal)</div>
<div class="line">        <span class="keywordflow">return</span> equal-&gt;<a class="code" href="structfa__equal__t.html#acd1ed940afe1760fc0246fb6e774445f">equal</a>(a, b);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        <span class="keywordflow">return</span> a == b;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="Defining"></a>
Defining an interface</h1>
<p>To define a new interface, the following has to be provided:</p>
<ul>
<li>An interface struct</li>
<li>An interface identifier</li>
</ul>
<p>The struct is simply a typedef defining the types of the interface, for example</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line"></div>
<div class="line">    bool (* less_than)(<span class="keywordtype">void</span> *, <span class="keywordtype">void</span> *);</div>
<div class="line"></div>
<div class="line">    bool (* greater_than)(<span class="keywordtype">void</span> *, <span class="keywordtype">void</span> *);</div>
<div class="line"></div>
<div class="line">} <a class="code" href="structfa__order__t.html" title="Less-than comparison interface.">fa_order_t</a>;</div>
</div><!-- fragment --><p>The identifier should be defined as a macro or enum constant defining a unique number.</p>
<div class="fragment"><div class="line"><span class="keyword">enum</span> { <a class="code" href="interfaces_8h.html#a7c337b4de759549a84c656770ce01cd2ae08a92558a44d2796dc2a5df8ff1b3c3">fa_order_i</a> = 255; };</div>
</div><!-- fragment --><p>As described above, it is good style to also provide a generic function wrapping each method:</p>
<div class="fragment"><div class="line"><span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="group___fa.html#ga02de7d3cb44fba7a2b9cafa567e41307">fa_less_than</a> (<span class="keywordtype">void</span> *, <span class="keywordtype">void</span> *)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="group___fa.html#ga95dbbc4b32707af0a81071e8870d86c5" title="Returns an implenentation of the given interface on the given value.">fa_interface</a>(<a class="code" href="interfaces_8h.html#a7c337b4de759549a84c656770ce01cd2ae08a92558a44d2796dc2a5df8ff1b3c3">fa_order_i</a>, a)-&gt;less_than(a, b);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="group___fa.html#gae1a5b993761f7ec95c0058721642bebf">fa_greater_than</a> (<span class="keywordtype">void</span> *, <span class="keywordtype">void</span> *)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="group___fa.html#ga95dbbc4b32707af0a81071e8870d86c5" title="Returns an implenentation of the given interface on the given value.">fa_interface</a>(<a class="code" href="interfaces_8h.html#a7c337b4de759549a84c656770ce01cd2ae08a92558a44d2796dc2a5df8ff1b3c3">fa_order_i</a>, a)-&gt;greater_than(a, b);</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="Implementing"></a>
Implementing an interface</h1>
<p>To implement an interface for a reference type, the following has to be provided:</p>
<ul>
<li>Functions implementing the interface methods</li>
<li>A dispatch function of type <a class="el" href="group___fa.html#gac13cc6d4ef02b8763045164333cfd763">fa_impl_t</a></li>
<li>A field in the type that points to the dispatch function</li>
<li>A construction routine that sets the pointer to the dispatch function</li>
</ul>
<p>The dispatch function is unique for each type, and performs a case matching on the incoming interface identifiers, returning a pointer to the appropriate interface struct.</p>
<p>As an example, let us write a custom reference type <code>foo</code>, implementing <a class="el" href="structfa__equal__t.html">fa_equal_t</a> and <a class="el" href="structfa__order__t.html" title="Less-than comparison interface.">fa_order_t</a>.</p>
<h2><a class="anchor" id="Methods"></a>
The methods</h2>
<p>The methods are written as ordinary functions, which have the same type as the functions declared in the interface struct. These functions does need not be exported.</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> foo_equal(<span class="keywordtype">void</span> *a, <span class="keywordtype">void</span> *b)</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> foo_less_than(<span class="keywordtype">void</span> *a, <span class="keywordtype">void</span> *b)</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> foo_greater_than(<span class="keywordtype">void</span> *a, <span class="keywordtype">void</span> *b)</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="Dispatch"></a>
The dispatch function</h2>
<p>The dispatch function should have the type fa_impl_t. For example:</p>
<div class="fragment"><div class="line"><a class="code" href="group___fa.html#ga915ddeae99ad7568b273d2b876425197" title="Pointer type, equivalent to void*.">fa_ptr_t</a> foo_impl(<a class="code" href="group___fa.html#gaeb5011c69dfea4d2c41c05a2c95899d0" title="Unique identifier.">fa_id_t</a> interface)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">static</span> <a class="code" href="structfa__equal__t.html" title="Equality comparison interface.">fa_equal_t</a> foo_equal_impl = { foo_equal };</div>
<div class="line">    <span class="keyword">static</span> <a class="code" href="structfa__order__t.html" title="Less-than comparison interface.">fa_order_t</a> foo_order_impl = { foo_less_than, foo_greater_than };</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">switch</span> (interface)</div>
<div class="line">    {</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="interfaces_8h.html#a7c337b4de759549a84c656770ce01cd2a9b8bb278c9a713e6ec54d275002e0a01">fa_equal_i</a>:</div>
<div class="line">        <span class="keywordflow">return</span> &amp;foo_equal_impl;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="interfaces_8h.html#a7c337b4de759549a84c656770ce01cd2ae08a92558a44d2796dc2a5df8ff1b3c3">fa_order_i</a>:</div>
<div class="line">        <span class="keywordflow">return</span> &amp;foo_order_impl;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="Pointer"></a>
The interface pointer</h2>
<p>The address of the dispatch function has to be the <em>first</em> element of the implementing type. The name of the fields is irrelevant, typically <code>impl</code> is used.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>foo</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group___fa.html#gac13cc6d4ef02b8763045164333cfd763" title="Callback to lookup an interface implementation.">fa_impl_t</a> impl;     <span class="comment">//  Interface dispatcher</span></div>
<div class="line">    ...</div>
<div class="line">};</div>
</div><!-- fragment --><p>The creation routine for the type should include a line to set up the <code>impl</code> field to the address of the dispatch function. Note that a forward declaration might be necessary here.</p>
<div class="fragment"><div class="line"><a class="code" href="group___fa.html#ga915ddeae99ad7568b273d2b876425197" title="Pointer type, equivalent to void*.">fa_ptr_t</a> foo_impl(<a class="code" href="group___fa.html#gaeb5011c69dfea4d2c41c05a2c95899d0" title="Unique identifier.">fa_id_t</a> interface);</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>foo *create_foo()</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>foo *foo = malloc(<span class="keyword">sizeof</span>(_foo));</div>
<div class="line">    foo-&gt;impl = &amp;foo_impl;                      <span class="comment">//  Setting up dispatcher</span></div>
<div class="line">    ...</div>
<div class="line">    <span class="keywordflow">return</span> foo;</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.3-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Oct 7 2013 16:06:57 for faudio v2.2.3 by &#160;<a href="http://www.doxygen.org/index.html">Doxygen<!-- <img class="footer" src="doxygen.png" alt="doxygen"/> --></a> 1.8.3
</small></address>
</body>
</html>
